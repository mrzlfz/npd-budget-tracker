import { defineSchema, defineTable } from "convex/server";
import { v } from "convex/values";

// Define the schema for our NPD Tracker application
export default defineSchema({
  // Organizations for multi-tenancy
  organizations: defineTable({
    name: v.string(),
    description: v.optional(v.string()),
    clerkOrganizationId: v.string(),
    createdAt: v.number(),
    updatedAt: v.number(),
  })
    .index("by_clerk_organization_id", ["clerkOrganizationId"])
    .index("by_created_at", ["createdAt"]),

  // Users and their organization memberships
  users: defineTable({
    clerkUserId: v.string(),
    email: v.string(),
    name: v.optional(v.string()),
    organizationId: v.id("organizations"),
    role: v.string(), // "admin", "pptk", "bendahara", "verifikator", "viewer"
    createdAt: v.number(),
    updatedAt: v.number(),
  })
    .index("by_clerk_user_id", ["clerkUserId"])
    .index("by_organization", ["organizationId"]),

  // RKA Programs (Top level - Program)
  rkaPrograms: defineTable({
    kode: v.string(), // e.g., "1.01.01.01"
    nama: v.string(),
    uraian: v.optional(v.string()),
    organizationId: v.id("organizations"),
    fiscalYear: v.number(),
    totalPagu: v.number(),
    status: v.string(), // "active", "inactive"
    createdBy: v.id("users"),
    createdAt: v.number(),
    updatedAt: v.number(),
  })
    .index("by_organization", ["organizationId"])
    .index("by_organization_fiscal_year", ["organizationId", "fiscalYear"])
    .index("by_kode", ["kode"]),

  // RKA Activities (Kegiatan - child of Programs)
  rkaKegiatans: defineTable({
    programId: v.id("rkaPrograms"),
    kode: v.string(), // e.g., "1.01.01.01.01"
    nama: v.string(),
    uraian: v.optional(v.string()),
    organizationId: v.id("organizations"),
    fiscalYear: v.number(),
    totalPagu: v.number(),
    status: v.string(), // "active", "inactive"
    createdBy: v.id("users"),
    createdAt: v.number(),
    updatedAt: v.number(),
  })
    .index("by_program", ["programId"])
    .index("by_organization", ["organizationId"])
    .index("by_organization_fiscal_year", ["organizationId", "fiscalYear"])
    .index("by_kode", ["kode"]),

  // RKA Sub Kegiatans (Sub Kegiatan - child of Kegiatans)
  rkaSubkegiatans: defineTable({
    kegiatanId: v.id("rkaKegiatans"),
    programId: v.id("rkaPrograms"), // Denormalized for performance
    kode: v.string(), // e.g., "1.01.01.01.01.01"
    nama: v.string(),
    uraian: v.optional(v.string()),
    organizationId: v.id("organizations"),
    fiscalYear: v.number(),
    totalPagu: v.number(),
    status: v.string(), // "active", "inactive"
    // Indikator kinerja
    indikatorOutput: v.optional(v.string()),
    targetOutput: v.optional(v.number()),
    satuanOutput: v.optional(v.string()),
    indikatorHasil: v.optional(v.string()),
    targetHasil: v.optional(v.number()),
    satuanHasil: v.optional(v.string()),
    createdBy: v.id("users"),
    createdAt: v.number(),
    updatedAt: v.number(),
  })
    .index("by_kegiatan", ["kegiatanId"])
    .index("by_program", ["programId"])
    .index("by_organization", ["organizationId"])
    .index("by_organization_fiscal_year", ["organizationId", "fiscalYear"])
    .index("by_kode", ["kode"]),

  // RKA Accounts (Akun Belanja 5.xx - child of Sub Kegiatans)
  rkaAccounts: defineTable({
    subkegiatanId: v.id("rkaSubkegiatans"),
    kegiatanId: v.id("rkaKegiatans"), // Denormalized for performance
    programId: v.id("rkaPrograms"), // Denormalized for performance
    kode: v.string(), // e.g., "5.1.01.01.01.001"
    uraian: v.string(),
    satuan: v.optional(v.string()),
    volume: v.optional(v.number()),
    hargaSatuan: v.optional(v.number()),
    paguTahun: v.number(), // Total budget allocation for the year
    realisasiTahun: v.number(), // Total realized amount for the year
    sisaPagu: v.number(), // Calculated: paguTahun - realisasiTahun
    status: v.string(), // "active", "inactive"
    organizationId: v.id("organizations"),
    fiscalYear: v.number(),
    createdBy: v.id("users"),
    createdAt: v.number(),
    updatedAt: v.number(),
  })
    .index("by_subkegiatan", ["subkegiatanId"])
    .index("by_kegiatan", ["kegiatanId"])
    .index("by_program", ["programId"])
    .index("by_organization", ["organizationId"])
    .index("by_organization_fiscal_year", ["organizationId", "fiscalYear"])
    .index("by_kode", ["kode"])
    .index("by_status", ["status"]),

  // NPD (Nota Pencairan Dana) documents
  npdDocuments: defineTable({
    title: v.string(),
    description: v.optional(v.string()),
    documentNumber: v.string(),
    jenis: v.string(), // "UP", "GU", "TU", "LS"
    subkegiatanId: v.id("rkaSubkegiatans"), // Link to specific sub kegiatan
    status: v.string(), // "draft", "diajukan", "diverifikasi", "final"
    organizationId: v.id("organizations"),
    createdBy: v.id("users"),
    verifiedBy: v.optional(v.id("users")),
    verifiedAt: v.optional(v.number()),
    finalizedBy: v.optional(v.id("users")),
    finalizedAt: v.optional(v.number()),
    catatan: v.optional(v.string()),
    tahun: v.number(),
    createdAt: v.number(),
    updatedAt: v.number(),
  })
    .index("by_organization", ["organizationId"])
    .index("by_subkegiatan", ["subkegiatanId"])
    .index("by_status", ["status"])
    .index("by_organization_tahun", ["organizationId", "tahun"])
    .index("by_organization_nomor", ["organizationId", "documentNumber"])
    .index("by_created_by", ["createdBy"]),

  // NPD Lines - Detail accounts included in an NPD
  npdLines: defineTable({
    npdId: v.id("npdDocuments"),
    accountId: v.id("rkaAccounts"),
    uraian: v.string(),
    jumlah: v.number(), // Amount requested for this line
    createdAt: v.number(),
    updatedAt: v.number(),
  })
    .index("by_npd", ["npdId"])
    .index("by_account", ["accountId"]),

  // SP2D References - Payment warrant information
  sp2dRefs: defineTable({
    npdId: v.id("npdDocuments"),
    noSPM: v.optional(v.string()),
    noSP2D: v.string(), // SP2D number (required)
    tglSP2D: v.number(), // SP2D date timestamp
    nilaiCair: v.number(), // Amount actually disbursed
    organizationId: v.id("organizations"),
    createdBy: v.id("users"),
    createdAt: v.number(),
    updatedAt: v.number(),
  })
    .index("by_npd", ["npdId"])
    .index("by_organization", ["organizationId"]),

  // Realizations - Track budget realization per account
  realizations: defineTable({
    accountId: v.id("rkaAccounts"),
    npdId: v.optional(v.id("npdDocuments")), // Optional link to NPD
    sp2dId: v.optional(v.id("sp2dRefs")), // Optional link to SP2D
    totalCair: v.number(), // Total amount realized
    catatan: v.optional(v.string()),
    organizationId: v.id("organizations"),
    createdBy: v.id("users"),
    createdAt: v.number(),
    updatedAt: v.number(),
  })
    .index("by_account", ["accountId"])
    .index("by_npd", ["npdId"])
    .index("by_sp2d", ["sp2dId"])
    .index("by_organization", ["organizationId"]),

  // Performance Logs - Track performance indicators
  performanceLogs: defineTable({
    subkegiatanId: v.id("rkaSubkegiatans"),
    indikatorNama: v.string(),
    target: v.number(),
    realisasi: v.number(),
    satuan: v.string(),
    periode: v.string(), // e.g., "TW1", "TW2", "TW3", "TW4", or month names
    buktiURL: v.optional(v.string()), // URL to evidence file
    keterangan: v.optional(v.string()),
    organizationId: v.id("organizations"),
    createdBy: v.id("users"),
    createdAt: v.number(),
    updatedAt: v.number(),
  })
    .index("by_subkegiatan", ["subkegiatanId"])
    .index("by_organization", ["organizationId"])
    .index("by_periode", ["periode"])
    .index("by_indikator", ["indikatorNama"]),

  // Attachments - File attachments for NPD documents
  attachments: defineTable({
    npdId: v.id("npdDocuments"),
    jenis: v.string(), // Type of attachment: "RAB", "BAST", "Kontrak", "Kwitansi", etc.
    url: v.string(), // File URL
    namaFile: v.string(), // Original filename
    ukuran: v.number(), // File size in bytes
    tipeMime: v.string(), // MIME type
    checksum: v.optional(v.string()), // File integrity checksum
    keterangan: v.optional(v.string()),
    organizationId: v.id("organizations"),
    uploadedBy: v.id("users"),
    createdAt: v.number(),
    updatedAt: v.number(),
  })
    .index("by_npd", ["npdId"])
    .index("by_organization", ["organizationId"])
    .index("by_jenis", ["jenis"]),

  // RKA Accounts - Budget accounts for activities
  rkaAccounts: defineTable({
    subkegiatanId: v.id("rkaSubkegiatans"),
    kegiatanId: v.id("rkaKegiatans"), // Denormalized for performance
    programId: v.id("rkaPrograms"), // Denormalized for performance
    kode: v.string(), // e.g., "5.1.01.01.001"
    uraian: v.string(),
    satuan: v.optional(v.string()),
    volume: v.optional(v.number()),
    hargaSatuan: v.optional(v.number()),
    paguTahun: v.number(), // Total budget allocation for year
    realisasiTahun: v.number(), // Total realized amount for year
    sisaPagu: v.number(), // Calculated: paguTahun - realisasiTahun
    status: v.string(), // "active", "inactive"
    organizationId: v.id("organizations"),
    fiscalYear: v.number(),
    createdBy: v.id("users"),
    createdAt: v.number(),
    updatedAt: v.number(),
  })
    .index("by_subkegiatan", ["subkegiatanId"])
    .index("by_kegiatan", ["kegiatanId"])
    .index("by_program", ["programId"])
    .index("by_organization", ["organizationId"])
    .index("by_organization_fiscal_year", ["organizationId", "fiscalYear"])
    .index("by_kode", ["kode"])
    .index("by_status", ["status"]),

  // NPD Files - File attachments for NPD documents (more detailed than attachments)
  npdFiles: defineTable({
    npdId: v.id("npdDocuments"),
    filename: v.string(),
    fileType: v.string(), // MIME type
    fileSize: v.number(), // File size in bytes
    fileUrl: v.string(), // URL or path to file
    status: v.string(), // "uploading", "uploaded", "error"
    uploadedBy: v.id("users"),
    organizationId: v.id("organizations"),
    uploadedAt: v.optional(v.number()),
    createdAt: v.number(),
  })
    .index("by_npd", ["npdId"])
    .index("by_organization", ["organizationId"])
    .index("by_status", ["status"]),

  // Activity logs for audit trail
  auditLogs: defineTable({
    action: v.string(), // "created", "updated", "submitted", "verified", "finalized", etc.
    entityTable: v.string(), // Table name: "rkaPrograms", "rkaKegiatans", "rkaSubkegiatans", "rkaAccounts", "npdDocuments", etc.
    entityId: v.string(), // ID as string to handle different table types
    entityData: v.optional(v.any()), // Before/after state for audit
    actorUserId: v.id("users"),
    organizationId: v.id("organizations"),
    ipAddress: v.optional(v.string()),
    userAgent: v.optional(v.string()),
    keterangan: v.optional(v.string()),
    createdAt: v.number(),
  })
    .index("by_organization", ["organizationId"])
    .index("by_actor", ["actorUserId"])
    .index("by_entity", ["entityTable", "entityId"])
    .index("by_created_at", ["createdAt"]),
});

// Types for our entities
export type Organization = {
  _id: any;
  name: string;
  description?: string;
  clerkOrganizationId: string;
  createdAt: number;
  updatedAt: number;
};

export type User = {
  _id: any;
  clerkUserId: string;
  email: string;
  name?: string;
  organizationId: any;
  role: string;
  createdAt: number;
  updatedAt: number;
};

export type RKAProgram = {
  _id: any;
  kode: string;
  nama: string;
  uraian?: string;
  organizationId: any;
  fiscalYear: number;
  totalPagu: number;
  status: string;
  createdBy: any;
  createdAt: number;
  updatedAt: number;
};

export type RKAKegiatan = {
  _id: any;
  programId: any;
  kode: string;
  nama: string;
  uraian?: string;
  organizationId: any;
  fiscalYear: number;
  totalPagu: number;
  status: string;
  createdBy: any;
  createdAt: number;
  updatedAt: number;
};

export type RKASubkegiatan = {
  _id: any;
  kegiatanId: any;
  programId: any;
  kode: string;
  nama: string;
  uraian?: string;
  organizationId: any;
  fiscalYear: number;
  totalPagu: number;
  status: string;
  indikatorOutput?: string;
  targetOutput?: number;
  satuanOutput?: string;
  indikatorHasil?: string;
  targetHasil?: number;
  satuanHasil?: string;
  createdBy: any;
  createdAt: number;
  updatedAt: number;
};

export type RKAAccount = {
  _id: any;
  subkegiatanId: any;
  kegiatanId: any;
  programId: any;
  kode: string;
  uraian: string;
  satuan?: string;
  volume?: number;
  hargaSatuan?: number;
  paguTahun: number;
  realisasiTahun: number;
  sisaPagu: number;
  status: string;
  organizationId: any;
  fiscalYear: number;
  createdBy: any;
  createdAt: number;
  updatedAt: number;
};

export type NPDDocument = {
  _id: any;
  title: string;
  description?: string;
  documentNumber: string;
  jenis: string;
  subkegiatanId: any;
  status: string;
  organizationId: any;
  createdBy: any;
  verifiedBy?: any;
  verifiedAt?: number;
  finalizedBy?: any;
  finalizedAt?: number;
  catatan?: string;
  tahun: number;
  createdAt: number;
  updatedAt: number;
};

export type NPDLine = {
  _id: any;
  npdId: any;
  accountId: any;
  uraian: string;
  jumlah: number;
  createdAt: number;
  updatedAt: number;
};

export type SP2DRef = {
  _id: any;
  npdId: any;
  noSPM?: string;
  noSP2D: string;
  tglSP2D: number;
  nilaiCair: number;
  organizationId: any;
  createdBy: any;
  createdAt: number;
  updatedAt: number;
};

export type Realization = {
  _id: any;
  accountId: any;
  npdId?: any;
  sp2dId?: any;
  totalCair: number;
  catatan?: string;
  organizationId: any;
  createdBy: any;
  createdAt: number;
  updatedAt: number;
};

export type PerformanceLog = {
  _id: any;
  subkegiatanId: any;
  indikatorNama: string;
  target: number;
  realisasi: number;
  satuan: string;
  periode: string;
  buktiURL?: string;
  keterangan?: string;
  organizationId: any;
  createdBy: any;
  createdAt: number;
  updatedAt: number;
};

export type RKAAccount = {
  _id: any;
  subkegiatanId: any;
  kegiatanId: any; // Denormalized for performance
  programId: any; // Denormalized for performance
  kode: string;
  uraian: string;
  satuan?: string;
  volume?: number;
  hargaSatuan?: number;
  paguTahun: number; // Total budget allocation for year
  realisasiTahun: number; // Total realized amount for year
  sisaPagu: number; // Calculated: paguTahun - realisasiTahun
  status: string; // "active", "inactive"
  organizationId: any;
  fiscalYear: number;
  createdBy: any;
  createdAt: number;
  updatedAt: number;
};

export type Attachment = {
  _id: any;
  npdId: any;
  jenis: string;
  url: string;
  namaFile: string;
  ukuran: number;
  tipeMime: string;
  checksum?: string;
  keterangan?: string;
  organizationId: any;
  uploadedBy: any;
  createdAt: number;
  updatedAt: number;
};

export type NPDFile = {
  _id: any;
  npdId: any;
  filename: string;
  fileType: string;
  fileSize: number;
  fileUrl: string;
  status: string;
  uploadedBy: any;
  organizationId: any;
  uploadedAt?: number;
  createdAt: number;
};

export type AuditLog = {
  _id: any;
  action: string;
  entityTable: string;
  entityId: string;
  entityData?: any;
  actorUserId: any;
  organizationId: any;
  ipAddress?: string;
  userAgent?: string;
  keterangan?: string;
  createdAt: number;
};